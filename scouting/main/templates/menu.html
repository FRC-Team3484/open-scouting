<div x-data="menu()">
    <div class="flex flex-row fixed bottom-2 right-2 justify-end w-screen items-center">
        <div x-show="notification_shown && !open" class="mx-4 w-full md:bottom-4 md:right-4 text-white text-md md:text-3xl p-1 md:p-2 dark:bg-slate-700/80 border-2 dark:border-slate-600 bg-slate-200/80 border-slate-300 rounded-full backdrop-blur-md" x-transition>
            <div class="flex flex-row items-center justify-between">
                <div class="flex flex-row dark:text-white text-black ml-2 items-center text-xl">
                    <i :class="notification.icon_class"></i>

                    <div class="flex flex-col ml-2">
                        <p class="text-sm font-bold" x-text="notification.title"></p>
                        <p class="text-sm" x-text="notification.body"></p>
                    </div>
                </div>

                <button class="ui_button_icon" @click="hide_notification()"><i class="ph-bold ph-x"></i></button>
            </div>
        </div>

        <div class="md:bottom-4 md:right-4 dark:text-white text-black text-xl md:text-3xl p-1 md:p-2 dark:bg-slate-700/80 border-2 dark:border-slate-600 bg-slate-200/80 border-slate-300 rounded-full backdrop-blur-md hover:scale-110 active:scale-95 transition-all w-10 h-10 md:w-16 md:h-16 flex flex-row items-center justify-center" x-show="!open" @click="open = true" t-transition>
            <i class="ph-bold ph-list"></i>
        </div>
    </div>
    

    <div x-show="open" @click.outside="open = false" x-transition class="flex flex-col fixed bottom-0 z-10 inset-x-0 mx-auto bg-slate-200/80 dark:bg-slate-700/80 border-2 dark:border-slate-600 border-slate-300 rounded-t-2xl backdrop-blur-md w-screen md:w-3/4 lg:w-1/2 h-3/4 md:min-h-1/2 overflow-y-auto p-4" x-transition>
        <div class="flex flex-row justify-between items-center w-full border-b-2 dark:border-slate-600 border-slate-300 px-6 py-4">
            <div class="flex flex-row">
                <div class="flex flex-row dark:text-white text-black items-center text-xl font-bold" x-data="menu_clock()">
                    <i class="ph-bold ph-clock mr-1"></i>
                    <p x-text="hour"></p>
                    <p class="animate-pulse">:</p>
                    <p x-text="minute"></p>
                </div>
    
                <script>
                    function menu_clock() {
                        return {
                            hour: 0,
                            minute: 0,
    
                            update_time() {
                                let now = new Date();
                                this.hour = now.toLocaleTimeString('en-US', { hour: '2-digit', hour12: true }).split(':')[0].replace(" PM", "").replace(" AM", "");
                                this.minute = now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes();

                                return now;
                            },
    
                            init() {    
                                let seconds_until_next_minute = 60 - this.update_time().getSeconds();
                                setTimeout(() => {
                                    this.update_time();
    
                                    setInterval(() => {
                                        this.update_time();
                                    }, 60000);
                                }, seconds_until_next_minute * 1000);
                            }
                        }
                    }
                </script>

                <div class="flex flex-row items-center dark:text-white text-black text-md mx-1 ml-2">
                    <i class="ph-bold ph-wifi-high" x-show="!offline"></i>
                    <i class="ph-bold ph-wifi-slash" x-show="offline"></i>
                </div>
            </div>
            

            <button class="ui_button_icon" @click="open = false"><i class="ph-bold ph-x"></i></button>
        </div>

        <div class="grid-cols-2 grid gap-x-2 gap-y-2 pt-6">
            <button class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md" @click="toggle_dark_mode()"><i class="ph-bold ph-moon" x-show="dark_mode" x-transition></i> <i class="ph-bold ph-sun" x-show="!dark_mode" x-transition></i> <p x-show="dark_mode">Light Mode</p> <p x-show="!dark_mode">Dark Mode</p></button>
            <button class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md" @click="toggle_offline_manual()"><i class="ph-bold ph-wifi-slash" x-show="offline_manual" x-transition></i> <i class="ph-bold ph-wifi-high" x-show="!offline_manual" x-transition></i> <p x-show="offline_manual">Go Online</p> <p x-show="!offline_manual">Go Offline</p></button>
        </div>

        <div class="grid-cols-2 grid gap-x-2 gap-y-2 pt-6">
            <a href="{{ SERVER_IP }}" class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md"><i class="ph-bold ph-house"></i> Home</a>
            <!-- TODO: Update these links when repo moves -->
            <a href="https://github.com/nfoert/open-scouting" class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md"><i class="ph-bold ph-github-logo"></i> Source Code</a>
            <a href="https://github.com/nfoert/open-scouting/releases" class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md"><i class="ph-bold ph-notebook"></i> Changelog</a>
            <a href="https://github.com/nfoert/open-scouting/issues" class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md"><i class="ph-bold ph-bug"></i> Report a Bug</a>
        </div>

        <div class="flex flex-col pt-6 w-full">
            <button @click="credits_open = !credits_open" class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md w-full"><i x-show="!credits_open" class="ph-bold ph-heart"></i> <i x-show="credits_open" class="ph-bold ph-x"></i> Credits</button>

            <div x-show="credits_open" x-collapse class="mx-6">
                <p class="dark:text-white text-black text-md pt-2">Powered by <a href="https://www.thebluealliance.com" class="dark:text-blue-400 text-blue-600 hover:dark:text-blue-500 hover:text-blue-700 transition-colors">The Blue Alliance</a></p>
            </div>
        </div>

        <div class="flex flex-col pt-6 w-full">
            <button @click="developer_open = !developer_open" class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md w-full"><i x-show="!developer_open" class="ph-bold ph-bug"></i> <i x-show="developer_open" class="ph-bold ph-x"></i> Developer Settings</button>

            <div x-show="developer_open" x-collapse class="grid=cols-2 grid gap-x-2 gap-y-2 pt-6 mx-6">
                <button class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md" @click="clear_service_worker_cache()">Clear service worker cache</button>
                <button class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md" @click="toggle_service_worker_mode()" x-show="service_worker_cache_first">Network-first service worker</button>
                <button class="dark:text-white text-black dark:bg-slate-700/80 bg-slate-200/80 backdrop-blur-md dark:border-slate-600 border-slate-300 border-2 rounded-lg py-4 hover:scale-105 active:scale-95 active:dark:bg-slate-800/60 active:bg-slate-300 transition-all hover:bg-slate-100 hover:dark:bg-slate-600 text-center text-md" @click="toggle_service_worker_mode()" x-show="!service_worker_cache_first">Cache-first service worker</button>
            </div>
        </div>
    </div>

    <div x-show="open" @click="open = false" class="z-5 fixed w-screen h-screen top-0 left-0 bg-black/20 backdrop-blur-lg" x-transition:enter="transition-all ease-in-out duration-300" x-transition:leave="transition-all ease-in-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"></div>
</div>

<script>
    function menu() {
        return {
            open: false,
            offline: !navigator.onLine,
            notification_shown: false,
            notification: {
                title: '',
                body: '',
                icon: '',
                icon_class: ''
            },
            dark_mode: true,
            credits_open: false,
            developer_open: false,
            service_worker_cache_first: true,
            offline_manual: false,
            offline_manual_last: false,

            offline_check() {
                console.log(this.offline, this.offline_manual);

                if (this.offline_manual == true && this.offline_manual_last == true) {
                    this.offline_manual_last = false;
                    window.dispatchEvent(new CustomEvent('scouting_offline'));
                    this.show_notification("Device offline", "You're now offline. Some features will be reduced until you're back online.", "wifi-slash");

                } else {
                    this.offline_manual_last = false;

                    if (this.offline != !navigator.onLine) {
                        this.offline = !navigator.onLine;

                        if (this.offline) {
                            window.dispatchEvent(new CustomEvent('scouting_offline'));
                            this.show_notification("Device offline", "You're now offline. Some features will be reduced until you're back online.", "wifi-slash");
                        } else {
                            window.dispatchEvent(new CustomEvent('scouting_online'));
                            this.show_notification("Device online", "You're back online.", "wifi-high");
                        }
                    }
                }
            },

            show_notification(title, body, icon) {
                if (this.notification_shown) {
                    this.hide_notification();
                }

                this.notification.title = title;
                this.notification.body = body;
                this.notification.icon = icon;
                this.notification.icon_class = "ph-bold ph-" + icon;
                this.notification_shown = true;

                setTimeout(() => {
                    this.hide_notification();
                }, 5000);
            },

            hide_notification() {
                this.notification_shown = false;
                this.notification.title = '';
                this.notification.body = '';
                this.notification.icon = '';
            },

            update_dark_mode() {
                if (this.dark_mode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            },

            toggle_dark_mode() {
                this.dark_mode = !this.dark_mode;
                this.update_dark_mode();
            },

            async clear_service_worker_cache() {
                await caches.delete('v1');
            },

            async toggle_service_worker_mode() {
                this.service_worker_cache_first = !this.service_worker_cache_first;
                localStorage.setItem("service_worker_cache_first", this.service_worker_cache_first);
                await caches.delete('v1');

                location.reload();
            },

            toggle_offline_manual() {
                this.offline_manual = !this.offline_manual;
                this.offline_manual_last = true;
                localStorage.setItem("offline_manual", this.offline_manual);

                window.dispatchEvent(new CustomEvent('sw_update_offline_manual'));
            },

            init() {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    this.dark_mode = true;
                } else {
                    this.dark_mode = false;
                }

                this.update_dark_mode();

                this.service_worker_cache_first = JSON.parse(localStorage.getItem("service_worker_cache_first"));
                this.offline_manual = JSON.parse(localStorage.getItem("offline_manual"));

                if (this.offline_manual == true) {
                    this.offline_manual_last = true;
                }

                // Check every half a second if the user is offline or not
                setInterval(() => {
                    this.offline_check();
                }, 500);

                window.addEventListener('scouting_notification', (event) => {
                    event.stopImmediatePropagation();
                    const { title, body, icon } = event.detail;
                    this.show_notification(title, body, icon);
                });

                // this.show_notification('Open Scouting', 'Welcome to Open Scouting!', 'star');
            }
        }
    }
</script>