{% extends "base.html" %}
{% load static %}
{% block head_title %}Open Scouting{% endblock %}

{% block head_scripts %}
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css"
          rel="stylesheet">
    <script type="text/javascript"
            src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
{% endblock %}

{% block stylesheets %}{% endblock %}

{% block body %}
    <div class="flex flex-col min-h-screen w-screen items-center justify-center">
        <div class="flex flex-row w-full md:w-3/4 lg:w-2/3 mx-8 my-4 py-2 dark:bg-slate-800 border-2 dark:border-slate-700 bg-slate-200 border-slate-300 rounded-lg mb-4 items-center justify-center"
             x-data="advanced_data_header()">
            <img class="w-16 h-16 aspect-square m-2 hover:scale-110 transition-all ease-in-out active:scale-95"
                 src="{% static '/main/images/icon_rounded.png' %}"
                 @click="window.location.href = '{{ SERVER_IP }}'">

            <div class="flex flex-col">
                <div class="flex flex-row items-center">
                    <p class="dark:text-white text-black text-sans text-2xl">Advanced Data View</p>
                </div>
            </div>

        </div>

        <script>
            function advanced_data_header() {
                return {}
            }
        </script>

        <div class="flex flex-col w-full md:w-3/4 lg:w-2/3 mx-8 my-2 py-2 dark:bg-slate-800 border-2 dark:border-slate-700 bg-slate-200 border-slate-300 rounded-lg gap-2"
             x-data="filters()"
             x-show="!offline">
            <p class="dark:text-white text-black text-sans text-2xl ml-4">
                <i class="ph-bold ph-funnel"></i> Filters
            </p>
            <p class="dark:text-white text-black text-sans text-sm ml-6 opacity-80">
                Filter results by year and then by both teams and events. If both a team and event is shown, only data from that team recorded at that event is shown
            </p>
            <div class="flex flex-row items-center gap-2 ml-6" x-ref="year">
                <p class="dark:text-white text-black text-sans text-lg">Year</p>
                <select class="ui_input w-32!"
                        x-ref="year_input"
                        @input="update_results_and_query();">
                    <template x-for="year in YEARS" :key="year">
                        <option x-text="year"></option>
                    </template>
                </select>
            </div>
            <div class="flex flex-row items-center gap-2 ml-6 flex-wrap" x-ref="teams">
                <p class="dark:text-white text-black text-sans text-lg">Teams</p>
                <template x-for="team in teams" :key="teams.indexOf(team)">
                    <button class="ui_button_small flex! flex-row! items-center gap-1"
                            @click="remove_team(team)">
                        <i class="ph-bold ph-x"></i>
                        <img class="w-4 h-4 aspect-square rounded-full"
                             :src='"https://thebluealliance.com/avatar/" + $refs.year_input.value + "/frc" + team + ".png"'
                             @error="event.target.style.display = 'none'">
                        <p x-text="team"></p>
                    </button>
                </template>
                <button class="ui_button_small opacity-80"
                        x-ref="teams_add"
                        @click="add_team_open = !add_team_open">
                    <i class="ph-bold ph-plus"></i> Add
                </button>
            </div>
            <div class="dark:bg-slate-800/80 border-2 dark:border-slate-700 bg-slate-200/80 border-slate-300 rounded-xl flex flex-col backdrop-blur-md z-10 p-2 max-w-screen max-h-64 overflow-y-scroll"
                 x-anchor.offset.5="$refs.teams_add"
                 x-show="add_team_open"
                 x-transition
                 @click.outside="add_team_open = false">
                <div class="flex flex-row items-center gap-2">
                    <input class="ui_input w-full!"
                           type="text"
                           placeholder="Search for a team..."
                           x-ref="teams_search"
                           @input="update_team_search()">
                    <button class="ui_button_small"
                            @click="add_team_open = false; $refs.teams_search.value = ''">
                        <i class="ph-bold ph-x"></i>
                    </button>
                </div>

                <template x-for="team in team_results_filtered">
                    <div class="flex flex-row mx-4 my-1 dark:hover:bg-slate-700/80 hover:bg-slate-200/80 dark:active:bg-slate-600/80 active:bg-slate-100/80 rounded-lg transition-colors"
                         @click="add_team(team)">
                        <img class="w-8 h-8 aspect-square m-2"
                             :src='"https://thebluealliance.com/avatar/" + $refs.year_input.value + "/frc" + team + ".png"'
                             @error="event.target.style.display = 'none'">
                        <p class="dark:text-white text-black text-sans text-md m-2"
                           x-text="team"></p>
                    </div>
                </template>
            </div>

            <div class="flex flex-row items-center gap-2 ml-6 flex-wrap"
                 x-ref="events">
                <p class="dark:text-white text-black text-sans text-lg">Events</p>
                <template x-for="event in events" :key="events.indexOf(event)">
                    <button class="ui_button_small flex! flex-row! items-center gap-1"
                            @click="remove_event(event)">
                        <i class="ph-bold ph-x"></i>
                        <p x-text="event.name"></p>
                    </button>
                </template>
                <button class="ui_button_small opacity-80"
                        x-ref="events_add"
                        @click="add_event_open = !add_event_open">
                    <i class="ph-bold ph-plus"></i> Add
                </button>
            </div>
            <div class="dark:bg-slate-800/80 border-2 dark:border-slate-700 bg-slate-200/80 border-slate-300 rounded-xl flex flex-col backdrop-blur-md z-10 p-2 max-w-screen max-h-64 overflow-y-scroll"
                 x-anchor.offset.5="$refs.events_add"
                 x-show="add_event_open"
                 x-transition
                 @click.outside="add_event_open = false">
                <div class="flex flex-row items-center gap-2">
                    <input class="ui_input w-full!"
                           type="text"
                           placeholder="Search for an event..."
                           x-ref="events_search"
                           @input="update_event_search()">
                    <button class="ui_button_small"
                            @click="add_event_open = false; this.$refs.events_search.value = ''">
                        <i class="ph-bold ph-x"></i>
                    </button>
                </div>

                <template x-for="event in event_results_filtered">
                    <div class="flex flex-col mx-4 my-1 dark:hover:bg-slate-700/80 hover:bg-slate-200/80 dark:active:bg-slate-600/80 active:bg-slate-100/80 rounded-lg transition-colors"
                         @click="add_event(event)">
                        <p class="dark:text-white text-black text-sans text-md m-2"
                           x-text="event.name"></p>
                        <p class="dark:text-white text-black text-sans font-mono text-sm opacity-80 ml-2"
                           x-text="event.code"></p>
                    </div>
                </template>
            </div>
            <p class="dark:text-white text-black font-mono text-sm ml-6 opacity-60 break-all mr-6"
               x-text="query"></p>
            <button class="ui_button_small ml-6" @click="clear_filters()">
                <i class="ph-bold ph-trash"></i> Clear Filters
            </button>

            <!-- TODO: Fix this later -->
            <div class="flex flex-col hidden!">
                <p class="dark:text-white text-black text-sans text-2xl ml-4 mt-4">
                    <i class="ph-bold ph-funnel-simple"></i> Sort By
                </p>
                <p class="dark:text-white text-black text-sans text-sm ml-6 opacity-80">
                    Sorts the data displayed below by each team by a stat. For example, sort the teams in descending order by the average coral scored during the autonomous period
                </p>
                <div class="flex flex-row mx-4 gap-2">
                    <select class="ui_input"
                            x-ref="sort_field"
                            @change="update_results_and_query()">
                        <template x-for="field in sort_fields">
                            <option :value="field.simple_name" x-text="field.name"></option>
                        </template>
                    </select>
                    <select class="ui_input"
                            x-ref="sort_order"
                            @change="update_results_and_query()">
                        <option value="descending">Descending (High to low)</option>
                        <option value="ascending">Ascending (Low to high)</option>
                    </select>
                </div>
            </div>

        </div>

        <script>
            function filters() {
                return {
                    YEARS: JSON.parse('{{ YEARS | safe }}').reverse(),
                    teams: [],
                    events: [],
                    query: "",
                    team_results: [],
                    event_results: [],
                    team_results_filtered: [],
                    event_results_filtered: [],
                    add_team_open: false,
                    add_event_open: false,
                    data: [],
                    data_sorted: [],
                    sort_fields: [],
                    offline: false,

                    get_query() {
                        var teams_str = "";
                        var events_str = "";

                        if (this.teams.length > 0) {
                            teams_str = "&teams=" + this.teams.join(",");
                        } else {
                            teams_str = "";
                        }
                        if (this.events.length > 0) {
                            events_str = "&events=" + this.events.map(event => event.code).join(",");
                        } else {
                            events_str = "";
                        }

                        this.query = `?year=${this.$refs.year_input.value}${teams_str}${events_str}`;

                        window.history.replaceState({}, '', this.query);
                    },

                    set_filters_from_query() {
                        var urlParams = new URLSearchParams(window.location.search);
                        var year = urlParams.get('year');
                        var teams = urlParams.get('teams');
                        var events = urlParams.get('events');

                        if (year) {
                            this.$refs.year_input.value = year;
                        }

                        if (teams) {
                            this.teams = teams.split(',');
                        }

                        if (events) {
                            this.events = events.split(',').map(code => {
                                return { code: code, name: code };
                            });
                        }

                        this.update_results_and_query();
                    },

                    clear_filters() {
                        this.teams = [];
                        this.events = [];
                        this.team_results = [];
                        this.event_results = [];
                        this.update_results_and_query();
                    },

                    add_team(team) {
                        this.teams.push(team);
                        this.$refs.teams_search.value = "";
                        this.update_results_and_query();
                    },

                    add_event(event) {
                        this.events.push(event);
                        this.$refs.events_search.value = "";
                        this.update_results_and_query();
                    },

                    remove_team(team) {
                        this.teams = this.teams.filter(t => t !== team);
                        this.update_results_and_query();
                    },

                    remove_event(event) {
                        this.events = this.events.filter(e => e !== event);
                        this.update_results_and_query();
                    },

                    update_results_and_query() {
                        this.get_teams_with_filters();
                        this.get_events_with_filters();
                        this.get_query();

                        this.get_data();
                        let data_promise = this.get_data();
                        data_promise.then(() => {
                            this.get_sortable_fields();
                        });

                        console.log(this.events)
                    },

                    update_team_search() {
                        let search = this.$refs.teams_search.value.toLowerCase();
                        this.team_results_filtered = this.team_results.filter(team => team.toLowerCase().includes(search));
                    },

                    update_event_search() {
                        let search = this.$refs.events_search.value.toLowerCase();
                        this.event_results_filtered = this.event_results.filter(event => event.name.toLowerCase().includes(search));
                    },

                    get_sortable_fields() {
                        let sort_fields = {};

                        if (!this.data) {
                            console.warn("No data available");
                            return [];
                        }

                        // Default sorting option
                        sort_fields["disabled"] = {
                            simple_name: "disabled",
                            name: "Don't sort"
                        };

                        // Process each team's auton & teleop sections
                        for (const team_number in this.data) {
                            const team_data = this.data[team_number];

                            ["auton", "teleop"].forEach(section => {
                                if (team_data[section]) {
                                    for (const game_piece in team_data[section]) {
                                        const game_piece_data = team_data[section][game_piece];

                                        ["score", "miss"].forEach(type => {
                                            if (game_piece_data[type]) {
                                                for (const field in game_piece_data[type]) {
                                                    sort_fields[field] = {
                                                        simple_name: field,
                                                        name: field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                                                    };
                                                }
                                            }
                                        });
                                    }
                                }
                            });
                        }

                        // Convert to array
                        this.sort_fields = Object.values(sort_fields);
                    },

                    sort_teams_by_field(data) {
                        if (!data) {
                            console.warn("No data available");
                            return [];
                        }

                        let field = this.$refs.sort_field.value;
                        let order = this.$refs.sort_order.value;

                        // Collect all team numbers (keys of the data object)
                        let teamList = Object.keys(data);

                        // Sort teams based on the selected field
                        teamList.sort((teamA, teamB) => {
                            let valueA = this.get_team_field_value(teamA, field);
                            let valueB = this.get_team_field_value(teamB, field);

                            // Handle undefined or null values by defaulting to 0
                            valueA = valueA || 0;
                            valueB = valueB || 0;

                            // Determine order of sorting
                            return order === "ascending" ? valueA - valueB : valueB - valueA;
                        });

                        // Create a new sorted array of objects
                        let sortedData = teamList.map(team => ({ teamNumber: team, data: data[team] }));

                        console.log(sortedData)

                        return sortedData;
                    },

                    // Helper function to get a team's value for a given field
                    get_team_field_value(team, field) {
                        let values = [];

                        // Loop through 'auton' and 'teleop' sections
                        ["auton", "teleop"].forEach(section => {
                            if (this.data[section]?.[team]) {
                                for (const game_piece in this.data[section][team]) {
                                    // Loop through 'score' and 'miss' types
                                    ["score", "miss"].forEach(type => {
                                        const fieldData = this.data[section][team][game_piece]?.[type]?.[field];
                                        if (fieldData?.average !== undefined) {
                                            values.push(fieldData.average);
                                        }
                                    });
                                }
                            }
                        });

                        // Handle capabilities section
                        if (this.data.capabilities?.[team]?.[field]) {
                            // If field is in capabilities, grab the first value or default to 0
                            values.push(Object.values(this.data.capabilities[team][field])[0] || 0);
                        }

                        return values;
                    },


                    async get_teams_with_filters() {
                        var response = await fetch("{{ SERVER_IP }}/get_teams_with_filters", {
                            method: "POST",
                            headers: {
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                            body: JSON.stringify({
                                year: this.$refs.year_input.value,
                                events: JSON.stringify(this.events)
                            })
                            });

                        if (response.ok) {
                            let results = await response.json();
                            this.team_results = [...new Set(results)].filter(t => !this.teams.includes(t));
                            this.team_results_filtered = this.team_results;
                            this.update_team_search();
                        }
                    },

                    async get_events_with_filters() {
                        var response = await fetch("{{ SERVER_IP }}/get_events_with_filters", {
                            method: "POST",
                            headers: {
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                            body: JSON.stringify({
                                year: this.$refs.year_input.value,
                                teams: JSON.stringify(this.teams)
                            })
                            });

                        if (response.ok) {
                            let results = await response.json();
                            this.event_results = [...new Map(results.map(event => [event.code, event])).values()]
                                .filter(event => !this.events.some(e => e.code === event.code));
                            this.event_results_filtered = this.event_results;
                            this.update_event_search();
                        }
                    },

                    parse_server_data(data) {
                        const final_data = {};

                        for (const team of data) {
                            const team_number = team.team_number;

                            if (!final_data[team_number]) {
                                final_data[team_number] = {
                                    auton: {},
                                    teleop: {},
                                    capabilities: {},
                                    other: []
                                };
                            }

                            team.data.forEach(match => {
                                match.forEach(field => {
                                    const { stat_type, game_piece, name, value } = field;

                                    switch (stat_type) {
                                        case "auton_score":
                                        case "auton_miss":
                                            if (!game_piece) break;
                                            if (!final_data[team_number].auton[game_piece]) {
                                                final_data[team_number].auton[game_piece] = { score: {}, miss: {} };
                                            }
                                            const autonType = stat_type === "auton_score" ? "score" : "miss";
                                            if (!final_data[team_number].auton[game_piece][autonType][name]) {
                                                final_data[team_number].auton[game_piece][autonType][name] = { values: [], average: 0, stat_type };
                                            }
                                            final_data[team_number].auton[game_piece][autonType][name].values.push(value);
                                            break;

                                        case "score":
                                        case "miss":
                                            if (!game_piece) break;
                                            if (!final_data[team_number].teleop[game_piece]) {
                                                final_data[team_number].teleop[game_piece] = { score: {}, miss: {} };
                                            }
                                            const teleopType = stat_type === "score" ? "score" : "miss";
                                            if (!final_data[team_number].teleop[game_piece][teleopType][name]) {
                                                final_data[team_number].teleop[game_piece][teleopType][name] = { values: [], average: 0, stat_type };
                                            }
                                            final_data[team_number].teleop[game_piece][teleopType][name].values.push(value);
                                            break;

                                        case "capability":
                                            if (!final_data[team_number].capabilities[name]) {
                                                final_data[team_number].capabilities[name] = {};
                                            }
                                            if (!final_data[team_number].capabilities[name][value]) {
                                                final_data[team_number].capabilities[name][value] = 0;
                                            }
                                            final_data[team_number].capabilities[name][value]++;
                                            break;

                                        case "other":
                                            final_data[team_number].other.push(value);
                                            break;
                                    }
                                });
                            });

                            // Calculate averages per field for auton
                            for (const game_piece in final_data[team_number].auton) {
                                const piece_data = final_data[team_number].auton[game_piece];
                                ["score", "miss"].forEach(type => {
                                    for (const field_name in piece_data[type]) {
                                        const field_data = piece_data[type][field_name];
                                        const count = field_data.values.length;
                                        field_data.average = count > 0 ? field_data.values.reduce((a, b) => a + b, 0) / count : 0;
                                    }
                                });
                            }

                            // Calculate averages per field for teleop
                            for (const game_piece in final_data[team_number].teleop) {
                                const piece_data = final_data[team_number].teleop[game_piece];
                                ["score", "miss"].forEach(type => {
                                    for (const field_name in piece_data[type]) {
                                        const field_data = piece_data[type][field_name];
                                        const count = field_data.values.length;
                                        field_data.average = count > 0 ? field_data.values.reduce((a, b) => a + b, 0) / count : 0;
                                    }
                                });
                            }

                            // Convert capability counts to percentages per team
                            const team_caps = final_data[team_number].capabilities;
                            for (const cap_name in team_caps) {
                                const cap_values = team_caps[cap_name];
                                const total_entries = Object.values(cap_values).reduce((a, b) => a + b, 0);
                                for (const value in cap_values) {
                                    cap_values[value] = (cap_values[value] / total_entries) * 100;
                                }
                            }
                        }

                        // console.log(final_data);

                        return final_data;
                    },


                    async get_data() {
                        var response = await fetch("{{ SERVER_IP }}/get_data_from_query", {
                            method: "POST",
                            headers: {
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                            body: JSON.stringify({
                                query: this.query
                            })
                        });

                        if (response.ok) {
                            this.data = this.parse_server_data(await response.json());
                            // this.data_sorted = this.sort_teams_by_field(this.data);
                            this.data_sorted = this.data;
                            window.dispatchEvent(new CustomEvent('data', {
                                detail: { data: this.data_sorted }
                            }));
                        }
                    },

                    init() {
                        // Wait to ensure year drop down is populated
                        setTimeout(() => {
                            var urlParams = new URLSearchParams(window.location.search);
                            var query = urlParams.toString();

                            if (query) {
                                this.query = query;
                                this.get_events_with_filters();
                                
                                this.set_filters_from_query();
                                this.update_results_and_query();
                            } else {
                                this.update_results_and_query();
                            }

                            this.get_data();

                            if (globalThis.offline) {
                                this.offline = true;
                            } else {
                                this.offline = false;
                            }
                        }, 100);
                    }
                }
            }
        </script>

        <div class="flex flex-col w-full md:w-1/2 lg:w-2/3"
             x-data="advanced_data()"
             x-init="init()">
            <template x-for="(teamData, teamNumber) in data" :key="teamNumber">
                <template x-if="Object.keys(teamData).length > 0">
                    <div class="flex flex-col px-4 py-2 dark:bg-slate-800 border-2 dark:border-slate-700 bg-slate-200 border-slate-300 rounded-lg mb-4 items-left"
                         x-data="{ open: false }">
                        <!-- Team Number -->
                        <div class="flex flex-row justify-between items-center cursor-pointer"
                             @click="open = !open">
                            <p class="dark:text-white text-black text-sans text-2xl"
                               x-text="teamNumber"></p>
                            <i class="ph-bold ph-caret-down dark:text-white text-black"
                               x-show="open"></i>
                            <i class="ph-bold ph-caret-up dark:text-white text-black" x-show="!open"></i>
                        </div>

                        <div x-show="open" x-collapse>
                            <!-- Sections: Auton, Teleop, Capabilities, Other -->
                            <template x-for="(section, sectionName) in teamData" :key="sectionName">
                                <div class="mt-4 px-4 py-2 border-l-2 dark:border-slate-600 border-slate-200"
                                     x-data="{ open: true }">
                                    <div class="flex flex-row justify-between items-center cursor-pointer"
                                         @click="open = !open">
                                        <p class="dark:text-white text-black text-xl font-semibold"
                                           x-text="sectionName.charAt(0).toUpperCase() + sectionName.slice(1)"></p>
                                        <i class="ph-bold ph-caret-down dark:text-white text-black"
                                           x-show="open"></i>
                                        <i class="ph-bold ph-caret-up dark:text-white text-black" x-show="!open"></i>
                                    </div>

                                    <div x-show="open" x-collapse>

                                        <!-- Game Pieces (for Auton & Teleop) -->
                                        <template x-if="sectionName === 'auton' || sectionName === 'teleop'">
                                            <template x-for="(pieceData, pieceName) in section" :key="pieceName">
                                                <div class="ml-4 mt-2 pl-2 border-l-2 dark:border-slate-600 border-slate-200">
                                                    <p class="dark:text-white text-black text-lg font-medium"
                                                       x-text="pieceName.charAt(0).toUpperCase() + pieceName.slice(1)"></p>

                                                    <div class="ml-4">
                                                        <!-- Iterate over 'score' and 'miss' -->
                                                        <template x-for="(categoryData, categoryName) in pieceData" :key="categoryName">
                                                            <div class="mt-2">
                                                                <p class="dark:text-white text-black text-md font-semibold"
                                                                   x-text="categoryName.charAt(0).toUpperCase() + categoryName.slice(1)"></p>

                                                                <div class="ml-4">
                                                                    <template x-for="(fieldData, fieldName) in categoryData" :key="fieldName">
                                                                        <div class="p-2 border dark:border-slate-700 border-slate-300 rounded-lg mb-2">
                                                                            <p class="dark:text-white text-black text-md font-medium"
                                                                               x-text="fieldName.replace(/_/g, ' ').charAt(0).toUpperCase() + fieldName.replace(/_/g, ' ').slice(1)">
                                                                            </p>
                                                                            <p class="dark:text-white text-black text-sm"
                                                                               x-text="`Average: ${fieldData.average?.toFixed(2) ?? 'N/A'}`"></p>
                                                                            <canvas x-init="create_line_chart($el, fieldData.values, fieldName, fieldData.stat_type)"></canvas>
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </template>

                                        <!-- Capabilities (Pie Chart Representation) -->
                                        <template x-if="sectionName === 'capabilities'">
                                            <div class="ml-4 mt-2">
                                                <template x-for="(capabilityValue, capabilityName) in section"
                                                          :key="capabilityName">
                                                    <div class="p-2 border dark:border-slate-700 border-slate-300 rounded-lg mb-2">
                                                        <p class="dark:text-white text-black text-lg font-semibold"
                                                           x-text="capabilityName.replace(/_/g, ' ').charAt(0).toUpperCase() + capabilityName.replace(/_/g, ' ').slice(1)"></p>
                                                        <div class="flex flex-row h-full items-center">
                                                            <div class="flex flex-col justify-center w-1/2">
                                                                <ul class="ml-4 list-disc list-inside">
                                                                    <template x-for="(percentage, key) in capabilityValue" :key="key">
                                                                        <li class="dark:text-white text-black text-sm"
                                                                            x-text="`${key.charAt(0).toUpperCase() + key.slice(1)}: ${Math.round(percentage * 100) / 100}%`"></li>
                                                                    </template>
                                                                </ul>
                                                            </div>
                                                            <div class="flex justify-center w-1/2">
                                                                <canvas x-init="create_donut_chart($el, Object.values(capabilityValue), Object.keys(capabilityValue), capabilityName)"></canvas>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>

                                        <!-- Other (List Representation) -->
                                        <template x-if="sectionName === 'other'">
                                            <div class="ml-4 mt-2">
                                                <ul class="ml-4 list-disc list-inside">
                                                    <template x-for="(option, index) in section" :key="index">
                                                        <li class="dark:text-white text-black text-md" x-text="option"></li>
                                                    </template>
                                                </ul>
                                            </div>
                                        </template>

                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </template>
            </div>

            <script>
            function advanced_data() {
                return {
                    data: {},
                    offline: false,

                    create_line_chart(canvas, data, label, type) {
                        const labels = data.map((_, i) => (i + 1).toString());
                        
                        const average = data.reduce((acc, val) => acc + val, 0) / data.length;
                        
                        const color = (type === "auton_score" || type === "score") ? "#51ff4e" : "#ff4e51";
                        
                        new Chart(canvas, {
                            type: "line",
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: `${label} Values`,
                                        data: data,
                                        borderWidth: 2,
                                        borderColor: color,
                                        fill: false
                                    }, 
                                    {
                                        label: "Average Values",
                                        data: Array(data.length).fill(average),
                                        borderWidth: 1,
                                        borderColor: color,
                                        borderDash: [5, 5],
                                        fill: false,
                                        pointRadius: 0,
                                        pointBackgroundColor: `rgba(${color === "#51ff4e" ? 81 : 255}, ${color === "#51ff4e" ? 255 : 78}, 0.5)`
                                    }
                                ]
                            },
                            options: {
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Reports'
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Values'
                                        }
                                    }
                                }
                            }
                        });
                    },

                    create_donut_chart(element, data, labels, title) {
                        new Chart(element, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                }],
                            },
                            options: {
                                aspectRatio: 1,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: title.charAt(0).toUpperCase() + title.slice(1).replace(/_/g, ' '),
                                    },
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            boxWidth: 10,
                                        }
                                    },
                                }
                            },
                        });
                    },
                    
                    init() {
                        window.addEventListener('data', (event) => {
                            event.stopImmediatePropagation();
                            const { data } = event.detail;
                            
                            this.data = data;
                        });

                        setTimeout(() => {
                            if (globalThis.offline) {
                                this.offline = true;
                            } else {
                                this.offline = false;
                            }
                        }, 100);
                    }
                }
            }
            </script>
        </div>

    {% endblock %}

    {% block scripts %}
    {% endblock %}
