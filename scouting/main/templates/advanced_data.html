{% extends "base.html" %}
{% load static %}
{% block head_title %}Open Scouting{% endblock %}

{% block head_scripts %}
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css"
          rel="stylesheet">
    <script type="text/javascript"
            src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
{% endblock %}

{% block stylesheets %}{% endblock %}

{% block body %}
    <div class="flex flex-col h-full min-h-screen w-screen overflow-hidden items-center justify-center">

        <div class="flex flex-row w-full md:w-3/4 lg:w-2/3 mx-8 my-4 py-2 dark:bg-slate-800 border-2 dark:border-slate-700 bg-slate-200 border-slate-300 rounded-lg mb-4 items-center justify-center"
             x-data="advanced_data_header()">
            <img class="w-16 h-16 aspect-square m-2 hover:scale-110 transition-all ease-in-out active:scale-95"
                 src="{% static '/main/images/icon_rounded.png' %}"
                 @click="window.location.href = '{{ SERVER_IP }}'">

            <div class="flex flex-col">
                <div class="flex flex-row items-center">
                    <p class="dark:text-white text-black text-sans text-2xl">Advanced Data View</p>
                </div>
            </div>

        </div>

        <script>
            function advanced_data_header() {
                return {}
            }
        </script>

        <div class="flex flex-col w-full md:w-3/4 lg:w-2/3 mx-8 my-2 py-2 dark:bg-slate-800 border-2 dark:border-slate-700 bg-slate-200 border-slate-300 rounded-lg gap-2"
             x-data="filters()">
            <p class="dark:text-white text-black text-sans text-2xl ml-4">
                <i class="ph-bold ph-funnel"></i> Filters
            </p>
            <div class="flex flex-row items-center gap-2 ml-6" x-ref="year">
                <p class="dark:text-white text-black text-sans text-lg">Year</p>
                <select class="ui_input !w-32"
                        x-ref="year_input"
                        @input="update_results_and_query();">
                    <template x-for="year in YEARS" :key="year">
                        <option x-text="year"></option>
                    </template>
                </select>
            </div>
            <div class="flex flex-row items-center gap-2 ml-6 flex-wrap" x-ref="teams">
                <p class="dark:text-white text-black text-sans text-lg">Teams</p>
                <template x-for="team in teams" :key="teams.indexOf(team)">
                    <button class="ui_button_small !flex !flex-row items-center gap-1"
                            @click="remove_team(team)">
                        <i class="ph-bold ph-x"></i>
                        <img class="w-4 h-4 aspect-square rounded-full"
                             :src='"https://thebluealliance.com/avatar/" + $refs.year_input.value + "/frc" + team + ".png"'
                             @error="event.target.style.display = 'none'">
                        <p x-text="team"></p>
                    </button>
                </template>
                <button class="ui_button_small opacity-80"
                        x-ref="teams_add"
                        @click="add_team_open = !add_team_open">
                    <i class="ph-bold ph-plus"></i> Add
                </button>
            </div>
            <div class="dark:bg-slate-800/80 border-2 dark:border-slate-700 bg-slate-200/80 border-slate-300 rounded-xl flex flex-col backdrop-blur-md z-10 p-2 max-w-screen max-h-64 overflow-y-scroll"
                 x-anchor.offset.5="$refs.teams_add"
                 x-show="add_team_open"
                 x-transition
                 @click.outside="add_team_open = false">
                <div class="flex flex-row items-center gap-2">
                    <input class="ui_input !w-full"
                           type="text"
                           placeholder="Search for a team..."
                           x-ref="teams_search"
                           @input="update_team_search()">
                    <button class="ui_button_small" @click="add_team_open = false">
                        <i class="ph-bold ph-x"></i>
                    </button>
                </div>

                <template x-for="team in team_results_filtered">
                    <div class="flex flex-row mx-4 my-1 hover:dark:bg-slate-700/80 hover:bg-slate-200/80 active:dark:bg-slate-600/80 active:bg-slate-100/80 rounded-lg transition-colors"
                         @click="add_team(team)">
                        <img class="w-8 h-8 aspect-square m-2"
                             :src='"https://thebluealliance.com/avatar/" + $refs.year_input.value + "/frc" + team + ".png"'
                             @error="event.target.style.display = 'none'">
                        <p class="dark:text-white text-black text-sans text-md m-2"
                           x-text="team"></p>
                    </div>
                </template>
            </div>

            <div class="flex flex-row items-center gap-2 ml-6 flex-wrap"
                 x-ref="events">
                <p class="dark:text-white text-black text-sans text-lg">Events</p>
                <template x-for="event in events" :key="events.indexOf(event)">
                    <button class="ui_button_small !flex !flex-row items-center gap-1"
                            @click="remove_event(event)">
                        <i class="ph-bold ph-x"></i>
                        <p x-text="event.name"></p>
                    </button>
                </template>
                <button class="ui_button_small opacity-80"
                        x-ref="events_add"
                        @click="add_event_open = !add_event_open">
                    <i class="ph-bold ph-plus"></i> Add
                </button>
            </div>
            <div class="dark:bg-slate-800/80 border-2 dark:border-slate-700 bg-slate-200/80 border-slate-300 rounded-xl flex flex-col backdrop-blur-md z-10 p-2 max-w-screen max-h-64 overflow-y-scroll"
                 x-anchor.offset.5="$refs.events_add"
                 x-show="add_event_open"
                 x-transition
                 @click.outside="add_event_open = false">
                <div class="flex flex-row items-center gap-2">
                    <input class="ui_input !w-full"
                           type="text"
                           placeholder="Search for an event..."
                           x-ref="events_search"
                           @input="update_event_search()">
                    <button class="ui_button_small" @click="add_event_open = false">
                        <i class="ph-bold ph-x"></i>
                    </button>
                </div>

                <template x-for="event in event_results_filtered">
                    <div class="flex flex-col mx-4 my-1 hover:dark:bg-slate-700/80 hover:bg-slate-200/80 active:dark:bg-slate-600/80 active:bg-slate-100/80 rounded-lg transition-colors"
                         @click="add_event(event)">
                        <p class="dark:text-white text-black text-sans text-md m-2"
                           x-text="event.name"></p>
                        <p class="dark:text-white text-black text-sans font-mono text-sm opacity-80 ml-2"
                           x-text="event.code"></p>
                    </div>
                </template>
            </div>
            <p class="dark:text-white text-black font-mono text-sm ml-6 opacity-60"
               x-text="query"></p>
            <button class="ui_button_small ml-6" @click="clear_filters()">
                <i class="ph-bold ph-trash"></i> Clear Filters
            </button>
        </div>

        <script>
            function filters() {
                return {
                    YEARS: JSON.parse('{{ YEARS | safe }}').reverse(),
                    teams: [],
                    events: [],
                    query: "",
                    team_results: [],
                    event_results: [],
                    team_results_filtered: [],
                    event_results_filtered: [],
                    add_team_open: false,
                    add_event_open: false,
                    data: [],

                    get_query() {
                        var teams_str = "";
                        var events_str = "";

                        if (this.teams.length > 0) {
                            teams_str = "&teams=" + this.teams.join(",");
                        } else {
                            teams_str = "";
                        }
                        if (this.events.length > 0) {
                            events_str = "&events=" + this.events.map(event => event.code).join(",");
                        } else {
                            events_str = "";
                        }

                        this.query = `?year=${this.$refs.year_input.value}${teams_str}${events_str}`;
                    },

                    clear_filters() {
                        this.teams = [];
                        this.events = [];
                        this.team_results = [];
                        this.event_results = [];
                        this.update_results_and_query();
                    },

                    add_team(team) {
                        this.teams.push(team);
                        this.update_results_and_query();
                    },

                    add_event(event) {
                        this.events.push(event);
                        this.update_results_and_query();
                    },

                    remove_team(team) {
                        this.teams = this.teams.filter(t => t !== team);
                        this.update_results_and_query();
                    },

                    remove_event(event) {
                        this.events = this.events.filter(e => e !== event);
                        this.update_results_and_query();
                    },

                    update_results_and_query() {
                        this.get_teams_with_filters();
                        this.get_events_with_filters();
                        this.get_query();

                        this.get_data();
                    },

                    update_team_search() {
                        let search = this.$refs.teams_search.value.toLowerCase();
                        this.team_results_filtered = this.team_results.filter(team => team.toLowerCase().includes(search));
                    },

                    update_event_search() {
                        let search = this.$refs.events_search.value.toLowerCase();
                        this.event_results_filtered = this.event_results.filter(event => event.name.toLowerCase().includes(search));
                    },

                    async get_teams_with_filters() {
                        var response = await fetch("{{ SERVER_IP }}/get_teams_with_filters", {
                            method: "POST",
                            headers: {
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                            body: JSON.stringify({
                                year: this.$refs.year_input.value,
                                events: JSON.stringify(this.events)
                            })
                            });

                        if (response.ok) {
                            let results = await response.json();
                            this.team_results = [...new Set(results)].filter(t => !this.teams.includes(t));
                            this.team_results_filtered = this.team_results;
                            this.update_team_search();
                        }
                    },

                    async get_events_with_filters() {
                        var response = await fetch("{{ SERVER_IP }}/get_events_with_filters", {
                            method: "POST",
                            headers: {
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                            body: JSON.stringify({
                                year: this.$refs.year_input.value,
                                teams: JSON.stringify(this.teams)
                            })
                            });

                        if (response.ok) {
                            let results = await response.json();
                            this.event_results = [...new Map(results.map(event => [event.code, event])).values()]
                                .filter(event => !this.events.some(e => e.code === event.code));
                            this.event_results_filtered = this.event_results;
                            this.update_event_search();
                        }
                    },

                    parse_server_data(data) {
                        // Parses the data from the server and creates a big object used to display the front end
                        const final_data = {
                            auton: {},
                            teleop: {},
                            capabilities: {},
                            other: {}
                        };

                        for (const team of data) {
                            const team_number = team.team_number;

                            // Initialize team entries if they don't exist
                            if (!final_data.auton[team_number]) {
                                final_data.auton[team_number] = {
                                    scores: [],
                                    misses: [],
                                    total_score: 0,
                                    total_miss: 0,
                                    average_score: 0,
                                    average_miss: 0
                                };
                            }

                            if (!final_data.teleop[team_number]) {
                                final_data.teleop[team_number] = {
                                    scores: [],
                                    misses: [],
                                    total_score: 0,
                                    total_miss: 0,
                                    average_score: 0,
                                    average_miss: 0
                                };
                            }

                            if (!final_data.capabilities[team_number]) {
                                final_data.capabilities[team_number] = {};
                            }

                            if (!final_data.other[team_number]) {
                                final_data.other[team_number] = [];
                            }

                            team.data.forEach(match => {
                                match.forEach(field => {
                                    switch (field.stat_type) {
                                        case "auton_score":
                                            final_data.auton[team_number].scores.push(field.value);
                                            final_data.auton[team_number].total_score += field.value;
                                            break;
                                        case "auton_miss":
                                            final_data.auton[team_number].misses.push(field.value);
                                            final_data.auton[team_number].total_miss += field.value;
                                            break;
                                        case "score":
                                            final_data.teleop[team_number].scores.push(field.value);
                                            final_data.teleop[team_number].total_score += field.value;
                                            break;
                                        case "miss":
                                            final_data.teleop[team_number].misses.push(field.value);
                                            final_data.teleop[team_number].total_miss += field.value;
                                            break;
                                        case "capability":
                                            const cap_name = field.name;
                                            const cap_value = field.value;

                                            if (!final_data.capabilities[team_number][cap_name]) {
                                                final_data.capabilities[team_number][cap_name] = {};
                                            }

                                            if (!final_data.capabilities[team_number][cap_name][cap_value]) {
                                                final_data.capabilities[team_number][cap_name][cap_value] = 0;
                                            }

                                            final_data.capabilities[team_number][cap_name][cap_value]++;
                                            break;
                                        case "other":
                                            final_data.other[team_number].push(field.value);
                                            break;
                                        default:
                                            break;
                                    }
                                });
                            });

                            // Calculate separate averages for auton
                            const auton_score_count = final_data.auton[team_number].scores.length;
                            const auton_miss_count = final_data.auton[team_number].misses.length;

                            final_data.auton[team_number].average_score = auton_score_count > 0
                                ? final_data.auton[team_number].total_score / auton_score_count
                                : 0;

                            final_data.auton[team_number].average_miss = auton_miss_count > 0
                                ? final_data.auton[team_number].total_miss / auton_miss_count
                                : 0;

                            // Calculate separate averages for teleop
                            const teleop_score_count = final_data.teleop[team_number].scores.length;
                            const teleop_miss_count = final_data.teleop[team_number].misses.length;

                            final_data.teleop[team_number].average_score = teleop_score_count > 0
                                ? final_data.teleop[team_number].total_score / teleop_score_count
                                : 0;

                            final_data.teleop[team_number].average_miss = teleop_miss_count > 0
                                ? final_data.teleop[team_number].total_miss / teleop_miss_count
                                : 0;
                        }

                        // Now convert raw counts in capabilities to percentages
                        for (const team_number in final_data.capabilities) {
                            const team_caps = final_data.capabilities[team_number];
                            for (const cap_name in team_caps) {
                                const cap_values = team_caps[cap_name];
                                const total_entries = Object.values(cap_values).reduce((a, b) => a + b, 0);

                                for (const value in cap_values) {
                                    cap_values[value] = (cap_values[value] / total_entries) * 100;
                                }
                            }
                        }

                        return final_data;
                    },

                    async get_data() {
                        var response = await fetch("{{ SERVER_IP }}/get_data_from_query", {
                            method: "POST",
                            headers: {
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                            body: JSON.stringify({
                                query: this.query
                            })
                        });

                        if (response.ok) {
                            this.data = this.parse_server_data(await response.json());
                        }
                    },

                    init() {
                        
                        // Wait to ensure year drop down is populated
                        setTimeout(() => {
                            this.update_results_and_query();
                            this.get_data();
                        }, 100);
                    }
                }
            }
        </script>
    </div>
{% endblock %}

{% block scripts %}
{% endblock %}
