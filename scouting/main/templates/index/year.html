<div class="flex flex-col justify-center items-center"
     x-data="year_select()"
     x-show="page == 2"
     x-transition>
    <p class="text-center dark:text-white text-black font-sans text-2xl mt-6 mb-4">
        <i class="ph-bold ph-calendar-dots"></i> Select year
    </p>

    <select class="ui_input"
            placeholder="Year"
            x-ref="year"
            @change="update_selected_year()">
        <template x-for="year in YEARS" :key="year">
            <option x-text="year"></option>
        </template>
    </select>

    <div class="flex flex-row mt-2">
        <p class="dark:text-white text-black font-sans text-md font-bold px-1"
           x-text="number_of_events"></p>
        <p class="dark:text-white text-black font-sans text-md font px-0.5"
           x-text="number_of_events == 1 ? 'event' : 'events'"></p>
        <p class="dark:text-white text-black font-sans text-md font px-0.5">with data this year</p>
    </div>

    <button class="ui_button" @click="next()">
        <i class="ph-bold ph-arrow-circle-right"></i> Next
    </button>
</div>

<script>
                function year_select() {
                    return {
                        YEARS: JSON.parse(`{{ YEARS|safe }}`).reverse(),
                        selected_year: new Date().getFullYear(),
                        number_of_events: 0,

                        update_selected_year() {
                            this.selected_year = this.$refs.year.value;
                            this.get_year_data();
                        },

                        async get_year_data() {
                            var response = await fetch("{{ SERVER_IP }}/get_year_data", {
                                    method: "POST",
                                    headers: {
                                        "year": this.selected_year
                                    }
                                });
                        
                            let year_data = JSON.parse(await response.json());
                            this.number_of_events = year_data["events"];
                        },

                        next() {
                            this.selected_year = this.$refs.year.value;

                            window.dispatchEvent(new CustomEvent('header_year', {
                                detail: { year: this.selected_year }
                            }));
                            this.page = 3;
                        },

                        init() {
                            setTimeout(() => {
                                this.selected_year = this.$refs.year.value;

                                this.get_year_data();
                            }, 100)
                            
                        }
                    };
                }
</script>
