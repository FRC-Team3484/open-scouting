{% extends "base.html" %}
{% load static %}
{% block head_title %}Open Scouting{% endblock %}

{% block head_scripts %}
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css"
          rel="stylesheet">
    <script type="text/javascript"
            src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
{% endblock %}

{% block stylesheets %}{% endblock %}

{% block body %}
    <div class="flex flex-col h-full min-h-screen w-screen overflow-hidden items-center justify-center">

        <div class="flex flex-row w-full md:w-3/4 lg:w-2/3 mx-8 my-4 py-2 dark:bg-slate-800 border-2 dark:border-slate-700 bg-slate-200 border-slate-300 rounded-lg mb-4 items-center justify-center"
             x-data="data_header()">
            <img class="w-16 h-16 aspect-square m-2 hover:scale-110 transition-all ease-in-out active:scale-95"
                 src="{% static '/main/images/icon_rounded.png' %}"
                 @click="window.location.href = '{{ SERVER_IP }}'">

            <div class="flex flex-col">
                <div class="flex flex-row items-center">
                    <button class="ui_button_icon mr-2" @click="go_to_contribute()">
                        <i class="ph-bold ph-pencil-simple"></i>
                    </button>
                    <p class="dark:text-white text-black text-sans text-2xl">Event Data</p>
                </div>

                <div class="flex flex-row" x-show="!demo">
                    <p class="dark:text-white text-black text-sans text-sm mx-1">Viewing data for event</p>
                    <p class="dark:text-white text-black text-sans font-bold text-sm mx-1">{{ event_name }}</p>
                    <p class="dark:text-white text-black text-sans text-sm mx-1">as</p>
                    <p class="dark:text-white text-black text-sans font-bold text-sm mx-1">{{ username }}</p>
                </div>

                <div class="flex flex-col p-2 ml-2 mt-2 rounded-lg border-solid border-2 dark:border-slate-600 dark:bg-purple-900/50 border-slate-300 bg-purple-200/50"
                     x-show="demo">
                    <p class="dark:text-white text-black font-sans text-md">
                        <i class="ph-bold ph-test-tube"></i> Open Scouting is in demo mode
                    </p>
                    <p class="dark:text-white text-black font-sans text-sm">Example contributed data is being shown, it is not data from any real matches or events</p>
                </div>
            </div>

        </div>

        <script>
        function data_header() {
            return {
                demo: false, 
                go_to_contribute() {
                    let url = new URL(window.location.href);
                    url.pathname = url.pathname.replace("/data", "/contribute");
                    window.location.href = url.toString();
                },

                init() {
                    try {
                        this.demo = JSON.parse("{{ demo }}");
                    } catch {
                        this.demo = false;
                    }
                }
            }
        }
        </script>

        <div class="w-full overflow-x-auto mx-16"
             x-data="dataTable()"
             x-init="init()"
             x-transition>
            <div x-show="!offline && !no_data" class="width-screen" x-ref="table"></div>

            <div class="flex flex-row w-screen items-center justify-center"
                 x-show="offline"
                 x-transition>
                <p class="dark:text-white text-black text-sans text-lg mx-1 text-center">
                    <i class="ph ph-wifi-slash"></i> You can't view data when you're offline.
                </p>
            </div>

            <div class="flex flex-row w-screen items-center justify-center"
                 x-show="no_data"
                 x-transition>
                <p class="dark:text-white text-black text-sans text-lg mx-1 text-center">
                    <i class="ph ph-info"></i> No data found for this event.
                </p>
            </div>
        </div>

        <script>
        function dataTable() {
            return {
                headers: [],
                entries: {},
                SERVER_IP: "{{ SERVER_IP }}",
                no_data: false,
                offline: false,

                generate_header_text(header_text) {
                    return header_text.replaceAll("_", " ").split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                },

                convert_headers_to_tabulator(headers) {
                    let new_headers = [];

                    for (header in headers) {
                        new_headers.push({title: this.generate_header_text(headers[header]), field: headers[header]});
                    }

                    return new_headers;
                },

                convert_entries_to_tabulator(entries) {
                    let new_entries = [];

                    for (entry in entries) {
                        new_entries.push(entries[entry].data);
                    }

                    return new_entries;
                },

                init() {
                    console.log("table started")
                    
                    fetch(
                        `${this.SERVER_IP}/get_data`, {
                        method: 'POST',
                        headers: {
                            "event-name": encodeURIComponent("{{ event_name }}"),
                            "event-code": "{{ event_code }}",
                            "custom": "{{ custom }}",
                            "year": "{{ year }}",
                            "demo": "{{ demo }}"
                        }
                    })
                    .then(response => response.json().then(json => {
                        this.headers = json.data_headers;
                        this.entries = json.data;

                        if (this.headers.length == 0) {
                            if (!this.offline) {
                                this.no_data = true;
                            }
                        }

                        console.log(this.headers)
                        console.log(this.convert_entries_to_tabulator(this.entries))

                        var tabledata = [
                            {id:1, name:"Oli Bob", age:"12", col:"red", dob:""},
                            {id:2, name:"Mary May", age:"1", col:"blue", dob:"14/05/1982"},
                            {id:3, name:"Christine Lobowski", age:"42", col:"green", dob:"22/05/1982"},
                            {id:4, name:"Brendon Philips", age:"125", col:"orange", dob:"01/08/1980"},
                            {id:5, name:"Margret Marmajuke", age:"16", col:"yellow", dob:"31/01/1999"},
                        ];

                        var table = new Tabulator(this.$refs.table, {
                            height: 205,
                            data: this.entries,
                            layout: "fitColumns",
                            columns: this.headers
                        });
                    }))
                    .then(data => console.log(data))
                    .catch(error => console.error(error));

                    if (navigator.onLine) {
                        this.offline = false;
                    } else {
                        this.offline = true;
                    }
                    
                    
                }
            }
        }
        </script>
    </div>
{% endblock %}

{% block scripts %}
{% endblock %}
