{% extends "base.html" %}
{% load static %}
{% block head_title %}Open Scouting{% endblock %}

{% block head_scripts %}{% endblock %}

{% block stylesheets %}{% endblock %}

{% block body %}
    <div class="flex justify-center items-center flex-col w-screen">
        <div class="flex flex-row w-full md:w-3/4 lg:w-2/3 mx-8 my-4 py-2 dark:bg-slate-800 border-2 dark:border-slate-700 bg-slate-200 border-slate-300 rounded-lg mb-4 items-center justify-center"
             x-data="pits_header()">
            <img class="w-16 h-16 aspect-square m-2 hover:scale-110 transition-all ease-in-out active:scale-95"
                 src="{% static '/main/images/icon_rounded.png' %}"
                 @click="window.location.href = '{{ SERVER_IP }}'">

            <div class="flex flex-col">
                <div class="flex flex-row items-center">

                    <button class="ui_button_icon mr-2" @click="go_to_data()">
                        <i class="ph-bold ph-hard-drives"></i>
                    </button>
                    <p class="dark:text-white text-black text-sans text-2xl">Pit Scouting</p>
                </div>

                <div class="flex flex-row" x-show="!demo">
                    <p class="dark:text-white text-black text-sans text-sm mx-1">Viewing pits for</p>
                    <p class="dark:text-white text-black text-sans font-bold text-sm mx-1">{{ event_name }}</p>
                    <p class="dark:text-white text-black text-sans text-sm mx-1">as</p>
                    <p class="dark:text-white text-black text-sans font-bold text-sm mx-1">{{ username }}</p>
                </div>

                <div class="flex flex-col p-2 ml-2 mt-2 rounded-lg border-solid border-2 dark:border-slate-600 dark:bg-purple-900/50 border-slate-300 bg-purple-200/50"
                     x-show="demo">
                    <p class="dark:text-white text-black font-sans text-md ">
                        <i class="ph-bold ph-test-tube"></i> Open Scouting is in demo mode
                    </p>
                    <p class="dark:text-white text-black font-sans text-sm">Any contributed data will not be saved to the server</p>
                </div>
            </div>
        </div>

        <script>
            function pits_header() {
                return {
                    demo: false,

                    go_to_data() {
                        let url = new URL(window.location.href);
                        url.pathname = url.pathname.replace("/contribute", "/data");
                        window.location.href = url.toString();
                    },

                    init() {
                        try {
                            this.demo = JSON.parse("{{ demo }}");
                        } catch {
                            this.demo = false;
                        }
                    }
                }
            }
        </script>

        <div x-data="pits()" class="w-full md:w-3/4 lg:w-2/3 mx-8">
            <div class="flex flex-row bg-slate-200/80 dark:bg-slate-700/80 border-2 dark:border-slate-600 border-slate-300 rounded-xl backdrop-blur-md p-4 my-2">
                <p class="dark:text-white text-black">List of pits that need scouted and filter buttons</p>
            </div>

            <div class="h-auto">
                <template x-for="pit in pit_data">
                    <div class="flex flex-col bg-slate-200/80 dark:bg-slate-700/80 border-2 dark:border-slate-600 border-slate-300 rounded-xl backdrop-blur-md p-4 my-2"
                         x-data="{ open: true }">
                        <div class="flex flex-row items-center justify-between">
                            <div class="flex flex-row">
                                <div class="rounded-md w-12 h-12 mr-2 bg-slate-200/80 dark:bg-slate-700/80 border-2 dark:border-slate-600 border-slate-300">
                                    <img :src="'https://www.thebluealliance.com/avatar/'+ '{{ year }}' + '/frc' + pit.team_number + '.png'"
                                         onerror="this.onerror=null;this.src='';this.style.display='none';"
                                         class="w-full h-full rounded-md">
                                </div>
                                <div class="flex flex-col w-fit">
                                    <p class="dark:text-white text-black text-xl font-bold mb-0 pb-0"
                                       x-text="pit.team_number"></p>
                                    <p class="dark:text-white text-black text-md opacity-80"
                                       x-text="pit.nickname"></p>
                                </div>

                            </div>
                            <div class="flex-1 mr-2 w-auto justify-end">
                                <p @click="open = !open"
                                   x-show="open"
                                   class="dark:text-white text-black cursor-pointer text-lg w-full text-right">
                                    <i class="ph-bold ph-caret-up"></i>
                                </p>
                                <p @click="open = !open"
                                   x-show="!open"
                                   class="dark:text-white text-black cursor-pointer text-lg w-full text-right">
                                    <i class="ph-bold ph-caret-down"></i>
                                </p>
                            </div>
                        </div>

                        <div class="flex flex-col mr-4" x-show="open" x-collapse>
                            <template x-for="question in pit.questions">
                                <div>
                                    <template x-if="question.answers && question.answers[0] && question.answers[0].value !== ''">
                                        <div class="flex flex-col" x-data="{ open: false }">
                                            <div class="ml-4 flex flex-row items-center my-1">
                                                <i class="ph-bold ph-check text-md text-green-600 mr-1"></i>
                                                <button class="ui_button_icon ml-2 mr-1 !w-10 !h-10">
                                                    <i class="ph-bold ph-plus-circle !text-md"></i>
                                                </button>
                                                <button class="ui_button_icon mr-2 ml-1 !w-10 !h-10" @click="open = !open">
                                                    <i class="ph-bold ph-eye !text-md" x-show="!open"></i>
                                                    <i class="ph-bold ph-eye-closed !text-md" x-show="open"></i>
                                                </button>
                                                <p class="dark:text-white text-black" x-text="question.text"></p>
                                                <p class="dark:text-white text-black opacity-80 ml-2 mr-2"
                                                   x-text="question.answers[0].value"
                                                   x-show="!open"
                                                   x-transition></p>
                                                <p class="dark:text-white text-black opacity-60"
                                                   x-text="'(' + question.answers.length + ' answers)'"
                                                   x-show="!open"
                                                   x-transition></p>
                                            </div>
                                            <div class="flex flex-row ml-8 flex-wrap" x-show="open" x-collapse>
                                                <template x-for="answer in question.answers">
                                                    <div class="flex flex-row items-end mx-1 mb-1">
                                                        <p class="dark:text-white text-black opacity-80" x-text="answer.value"></p>
                                                        <p class="dark:text-white text-black opacity-70 ml-1 text-xs"
                                                           x-text="'(' + answer.user + ')'"></p>
                                                        <p class="dark:text-white text-black opacity-70">,</p>
                                                    </div>

                                                </template>
                                            </div>
                                        </div>

                                    </template>

                                    <template x-if="!question.answers || question.answers.length < 1">
                                        <div class="ml-4 flex flex-row items-center my-1">
                                            <i class="ph-bold ph-x text-md text-red-500 mr-1"></i>
                                            <button class="ui_button_icon mx-2 !w-10 !h-10">
                                                <i class="ph-bold ph-plus-circle !text-md"></i>
                                            </button>
                                            <p class="dark:text-white text-black" x-text="question.text"></p>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <button class="ui_button_small ml-4 mt-1">
                                <i class="ph-bold ph-plus-circle"></i> Add Custom Question
                            </button>
                        </div>
                    </div>
                </template>

                <div class="flex flex-col bg-slate-200/80 dark:bg-slate-700/80 border-2 dark:border-slate-600 border-slate-300 rounded-xl backdrop-blur-md p-4 mt-2 mb-4">
                    <p class="dark:text-white text-black text-lg text-center">Is a team's pit not here yet?</p>
                    <button class="ui_button">
                        <i class="ph-bold ph-plus-circle"></i> Add a pit
                    </button>
                </div>
            </div>

            <script>
            function pits() {
                return {
                    pit_data: [],

                    async init() {
                        var response = await fetch("{{ SERVER_IP }}/get_pits", {
                            method: "POST",
                            headers: {
                                    "event-name": encodeURIComponent("{{ event_name }}"),
                                    "event-code": "{{ event_code }}",
                                    "custom": "{{ custom }}",
                                    "year": "{{ year }}"
                                }
                            });

                            response.text().then(async (text) => {
                                this.pit_data = JSON.parse(text);
                                console.log(this.pit_data);
                            });
                    }
                }
            }
            </script>
        </div>
    {% endblock %}

    {% block scripts %}
    {% endblock %}
