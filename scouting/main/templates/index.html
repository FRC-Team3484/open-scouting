{% extends "base.html" %}
{% load static %}
{% block head_title %}Open Scouting{% endblock %}

{% block head_scripts %}{% endblock %}

{% block stylesheets %}{% endblock %}

{% block body %}
    <div class="flex h-screen justify-center items-center flex-col w-screen">
        {% include "index/header.html" %}

        <div x-data="index()">
            {% include "index/authentication.html" %}

            {% include "index/year.html" %}

            {% include "index/events.html" %}

            <div class="flex flex-col justify-center items-center"
                 x-show="page == 4"
                 x-data="{ contribute_open: false }"
                 x-transition>
                <p class="text-center dark:text-white text-black font-sans text-2xl mb-4 mt-6">
                    <i class="ph-bold ph-sliders-horizontal"></i> Choose an Operation
                </p>
                <!-- TODO: Support scouting in sessions -->
                <!-- <button class="ui_button" @click="contribute_open = !contribute_open">
                    <i class="ph-bold ph-pencil-simple-line"></i> Contribute Data
                </button>
                <div class="flex flex-col justify-center items-center mb-6" x-show="contribute_open" x-collapse>
                    <button class="ui_button" disabled>
                        <i class="ph-bold ph-link"></i> Create a session
                    </button>
                    <p class="dark:text-white text-black opacity-80 text-sm text-center">
                        Create a session with one scout as the host to allow some more information to be autofilled and managed by the head scout
                    </p>
                    <button class="ui_button" @click="get_header_data('contribute_separately')">
                        <i class="ph-bold ph-pencil"></i> Contribute separately
                    </button>
                    <p class="dark:text-white text-black opacity-80 text-sm text-center">Contribute data without a session</p>
</div> -->

                <button class="ui_button" @click="get_header_data('contribute_separately')">
                    <i class="ph-bold ph-pencil"></i> Contribute separately
                </button>
                <p class="dark:text-white text-black opacity-80 text-sm text-center">Contribute data without a session</p>
                <button class="ui_button" @click="get_header_data('view_data')">
                    <i class="ph-bold ph-database"></i> View All Data
                </button>
                <p class="dark:text-white text-black opacity-80 text-sm text-center">View all data for this event</p>

                <p class="text-center dark:text-white text-black font-sans text-xl mb-1 mt-6">
                    <i class="ph-bold ph-export"></i> Share a link to this event
                </p>
                <p class="dark:text-white text-black opacity-80 text-sm text-center mb-6">Sharing a link allows scouts to easily get to the correct event to quickly begin scouting</p>

                <button class="ui_button" @click="get_link_data()">
                    <i class="ph-bold ph-link"></i> Copy Link
                </button>

                <div class="flex flex-col dark:bg-green-800/70 bg-green-400/70 dark:border-green-700 border-green-500 border-2 rounded-lg w-full px-6 py-4"
                     x-show="link"
                     x-transition>
                    <p class="dark:text-white text-black text-lg text-bold">
                        <i class="ph-bold ph-check-circle"></i> Link copied!
                    </p>
                </div>
            </div>
        </div>

        <script>
            function index() {
                return {
                    page: 1,
                    link: "",

                    get_header_data(load_page) {
                        window.dispatchEvent(new CustomEvent('get_header_data', {
                            detail: { load_page }
                        }));
                    },

                    get_link_data() {
                        window.dispatchEvent(new CustomEvent('get_link_data'));
                    },

                    load_page(page) {
                        if (!this.demo) {
                            if (page == "session") {
                                console.log("This feature is coming soon");
                            } else if (page == "contribute_separately") {
                                
                                if (!this.custom) {
                                    window.location.href = `{{ SERVER_IP }}/contribute?username=${encodeURIComponent(this.username)}&team_number=${encodeURIComponent(this.team_number)}&event_name=${encodeURIComponent(this.event_name)}&event_code=${this.event_code}&year=${this.year}&`;
                                } else {
                                    window.location.href = `{{ SERVER_IP }}/contribute?username=${encodeURIComponent(this.username)}&team_number=${encodeURIComponent(this.team_number)}&event_name=${encodeURIComponent(this.event_name)}&event_code=${this.event_code}&year=${this.year}&custom=true&`;
                                }
                            } else if (page == "view_data") {
                                if (!this.custom) {
                                    window.location.href = `{{ SERVER_IP }}/data?username=${encodeURIComponent(this.username)}&team_number=${encodeURIComponent(this.team_number)}&event_name=${encodeURIComponent(this.event_name)}&event_code=${this.event_code}&year=${this.year}&`;
                                } else {
                                    window.location.href = `{{ SERVER_IP }}/data?username=${encodeURIComponent(this.username)}&team_number=${encodeURIComponent(this.team_number)}&event_name=${encodeURIComponent(this.event_name)}&event_code=${this.event_code}&year=${this.year}&custom=true&`;
                                }
                            }
                        } else {
                            if (page == "session") {
                                console.log("This feature is coming soon");
                            } else if (page == "contribute_separately") {
                                window.location.href = `{{ SERVER_IP }}/contribute?year=${this.year}&demo=true&`;

                            } else if (page == "view_data") {
                                window.location.href = `{{ SERVER_IP }}/data?year=${this.year}&demo=true&`;
                            }
                        }
                    },

                    async copy_event_link() {
                        let link_to_event = `{{ SERVER_IP }}/?year=${this.year}&event_name=${encodeURIComponent(this.event_name)}&event_code=${this.event_code}`;

                        try {
                            await navigator.clipboard.writeText(link_to_event);
                            this.link = link_to_event;

                        } catch (err) {
                            console.error('Failed to copy: ', err);
                        }
                    },

                    init() {
                        window.addEventListener('start_over', (event) => {
                            this.page = 1
                        });

                        window.addEventListener('header_data', (event) => {
                            event.stopImmediatePropagation();
                            const { username, team_number, event_name, event_code, load_page, custom, year, demo } = event.detail;

                            this.username = username;
                            this.team_number = team_number;
                            this.event_name = event_name;
                            this.event_code = event_code;
                            this.custom = custom;
                            this.year = year;
                            this.demo = demo;
                            this.load_page(load_page);
                        });

                        window.addEventListener('link_data', (event) => {
                            event.stopImmediatePropagation();
                            const { username, team_number, event_name, event_code, custom, year, demo } = event.detail;

                            this.username = username;
                            this.team_number = team_number;
                            this.event_name = event_name;
                            this.event_code = event_code;
                            this.custom = custom;
                            this.year = year;
                            this.demo = demo;
                            this.copy_event_link();
                        });
                    }
                }
            }
        </script>

        {% include "index/custom_events.html" %}

    </div>
{% endblock %}

{% block scripts %}{% endblock %}
